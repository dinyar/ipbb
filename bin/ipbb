#!/usr/bin/env python
from __future__ import print_function


# --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Modules
import click
import ipbb

from texttable import Texttable

# ------------------------------------------------------------------------------
# Add -h as default help option
CONTEXT_SETTINGS = dict(help_option_names=['-h', '--help'])
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# @shell(
#     prompt=click.style('ipbb', fg='blue') + '> ',
#     intro='Starting IPBus Builder...',
#     context_settings=CONTEXT_SETTINGS
# )
@click.group(
    context_settings=CONTEXT_SETTINGS,
)
@click.pass_context
def cli(ctx):
    ctx.obj = ipbb.commands.Environment()

    # Print warning message if in command-line mode (no arguments) and we are not in an ipbb area.
    if not ctx.protected_args and not ctx.invoked_subcommand:
        print (ctx.obj)
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
@cli.command()
@click.option('-v', '--verbose', count=True, help='arse')
@click.pass_obj
def info(env, verbose):

    from click import echo, style, secho

    if not env.workPath:
        secho  ( 'No ipbb work area detected', fg='red' )
        return

    echo  ( )
    secho ( "ipbb environment", fg='blue' )
    # echo  ( "----------------")
    lEnvTable = Texttable(max_width=0)
    lEnvTable.add_row(["Work path", env.workPath])
    if env.projectPath:
        lEnvTable.add_row(["Project path", env.projectPath])
    echo(lEnvTable.draw())

    if not env.projectPath:
        echo  ( )
        secho ( "Firmware packages", fg='blue' )
        # echo  ( "---------------")
        # for s in env.getSources():
        #     echo ( "  - " + s )
        lSrcTable = Texttable()
        for lSrc in env.getSources():
            lSrcTable.add_row([lSrc])
        echo  ( lSrcTable.draw() )


        echo  ( )
        secho ( "Projects", fg='blue' )
        # echo  ( "--------")
        # for p in env.getProjects():
        #     echo ( "  - " + p )
        # echo  ( )
        lProjTable = Texttable()
        for lProj in env.getProjects():
            lProjTable.add_row([lProj])
        echo  ( lProjTable.draw() )
        return

    echo  ( )

    if env.projectConfig is None:
        return

    lProjTable = Texttable()
    lProjTable.set_deco(Texttable.VLINES | Texttable.BORDER)

    secho ( "Project '%s'" % env.projectConfig['name'], fg='blue')
    lProjTable.add_rows([
        # ["name", env.projectConfig['name']],
        ["toolset", env.projectConfig['toolset']],
        ["top package", env.projectConfig['topPkg']],
        ["top component", env.projectConfig['topCmp']],
        ["top dep file", env.projectConfig['topDep']],
        ], header=False)
    echo  ( lProjTable.draw() )

    echo  ( )

    secho ( "Dependecy tree elements", fg='blue')
    lCommandKinds = ['setup', 'src', 'addrtab', 'cgpfile']
    lDepTable = Texttable()
    lDepTable.set_cols_align(['c']*4)
    # lDepTable.header(lCommandKinds)
    lDepTable.add_row(lCommandKinds)
    lDepTable.add_row([len(env.depParser.CommandList[k]) for k in lCommandKinds])
    echo  ( lDepTable.draw() )

    echo  ( )

    if not env.depParser.NotFound:
        return
    secho  ( "Unresolved item(s)", fg='red' )

    lUnresolved = Texttable()
    lUnresolved.add_row(["packages", "components", "paths"])
    lUnresolved.add_row([len(env.depParser.PackagesNotFound), len(env.depParser.ComponentsNotFound), len(env.depParser.PathsNotFound )])
    echo ( lUnresolved.draw() )

    echo  ( )

# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
if __name__ == '__main__':
    '''Discovers the env at startup'''

    # Add custom commands to shell
    import ipbb.commands.repo as repo
    cli.add_command(repo.init)
    cli.add_command(repo.cd)
    cli.add_command(repo.add)

    import ipbb.commands.proj as proj
    cli.add_command(proj.proj)

    import ipbb.commands.dep as dep
    cli.add_command(dep.dep)

    import ipbb.commands.vivado as vivado
    cli.add_command(vivado.vivado)

    import ipbb.commands.sim as sim
    cli.add_command(sim.sim)

    cli()
# ------------------------------------------------------------------------------
